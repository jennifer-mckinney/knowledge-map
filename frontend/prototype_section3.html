<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Map v2.0 - Section 3: Graph Canvas</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* ===== BASE FROM SECTIONS 1 & 2 ===== */
        :root {
            --background: #fafafa;
            --surface: rgba(255, 255, 255, 0.98);
            --border: #e1e8ed;
            --text-primary: #14171a;
            --text-secondary: #657786;
            --accent-primary: #4a90a4;
            --accent-hover: #3a7a94;
            --primary-ghost: rgba(74, 144, 164, 0.08);
            --primary-light: rgba(74, 144, 164, 0.15);

            /* Cluster colors - EXACT from working file */
            --cluster-system: #6366f1;
            --cluster-education: #4ecdc4;
            --cluster-professional: #45b7d1;
            --cluster-technical: #96ceb4;
            --cluster-research: #85c1e9;
        }

        body.dark-theme {
            --background: #14171a;
            --surface: rgba(32, 35, 39, 0.98);
            --border: #3d4043;
            --text-primary: #f7f9fa;
            --text-secondary: #8899a6;
            --accent-primary: #6eb3c7;
            --accent-hover: #8ec4d6;
            --primary-ghost: rgba(110, 179, 199, 0.1);
            --primary-light: rgba(110, 179, 199, 0.2);

            /* Brighter in dark mode */
            --cluster-system: #7c7ff2;
            --cluster-education: #5eddd4;
            --cluster-professional: #55c7e1;
            --cluster-technical: #a6dec4;
            --cluster-research: #95d1f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            transition: background-color 0.25s ease-in-out, color 0.25s ease-in-out;
            overflow: hidden;
        }

        *,
        *::before,
        *::after {
            transition: background-color 0.25s ease-in-out,
                        border-color 0.25s ease-in-out,
                        color 0.25s ease-in-out;
        }

        /* Override for nav elements */
        .nav-link,
        .theme-toggle {
            transition: background-color 0.2s ease,
                        color 0.2s ease,
                        transform 0.2s ease !important;
        }

        /* ===== NAVIGATION BAR ===== */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .brand {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .nav-center {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--accent-primary);
            background: var(--primary-ghost);
        }

        .nav-link.active {
            color: var(--accent-primary);
            background: var(--primary-light);
        }

        .theme-toggle {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            font-size: 20px;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background: var(--primary-ghost);
        }

        /* ===== SECTION 3: GRAPH CANVAS ===== */

        #graph-container {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background);
        }

        svg {
            width: 100%;
            height: 100%;
            background: var(--background);
            cursor: grab;
        }

        svg:active {
            cursor: grabbing;
        }

        /* Graph elements - NO transition on these (they animate via D3) */
        .link {
            stroke: #666;
            stroke-opacity: 0.5;
            stroke-width: 1;
            transition: none !important;
            cursor: pointer;
        }

        .link.highlighted {
            stroke: var(--accent-primary);
            stroke-opacity: 0.8;
            stroke-width: 2;
        }

        .node {
            stroke-width: 0.5;
            cursor: pointer;
            transition: none !important;
        }

        .node:hover {
            stroke-width: 2;
            filter: brightness(1.1);
        }

        .node.highlighted {
            stroke-width: 4;
            stroke: var(--accent-primary);
            filter: drop-shadow(0 0 6px rgba(74, 144, 164, 0.4));
        }

        .node.dimmed {
            opacity: 0.3;
        }

        .label {
            font-size: 10px;
            font-weight: 500;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .label.dimmed {
            opacity: 0.2;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 10px 14px;
            background: rgba(20, 23, 26, 0.95);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2000;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            font-weight: 600;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 11px;
        }

        .tooltip-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .tooltip-value {
            font-weight: 500;
        }

        /* Info panel */
        .info-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            max-width: 250px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .info-item {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }

        .info-value {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: #22c55e;
            color: white;
        }

        /* Legend Bar */
        .legend {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 90vw;
        }

        .legend-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .legend-items {
            display: flex;
            gap: 15px;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
        }

        .legend-items::-webkit-scrollbar {
            height: 4px;
        }

        .legend-items::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 2px;
        }

        .legend-items::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .legend-items::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
            padding: 4px 8px;
            border-radius: 12px;
            position: relative;
        }

        .legend-item:hover {
            opacity: 0.7;
        }

        .legend-item.active {
            background: var(--primary-ghost);
        }

        .legend-item.active .legend-color {
            box-shadow: 0 0 0 4px var(--primary-light), 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.2s ease;
        }

        .legend-label {
            font-size: 11px;
            color: var(--text-primary);
            font-weight: 500;
            white-space: nowrap;
        }

        .legend-count {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Stats Bubble */
        .stats-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stats-bubble:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .stats-bubble-icon {
            font-size: 18px;
            line-height: 1;
        }

        .stats-expanded {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .stats-bubble.expanded .stats-expanded {
            display: block;
        }

        .stats-bubble.expanded {
            min-width: 160px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            font-size: 11px;
        }

        .stats-label {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stats-value {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-left">
            <span class="brand">Knowledge Map</span>
        </div>
        <div class="nav-center">
            <a href="#" class="nav-link active" data-layout="organic">Organic</a>
            <a href="#" class="nav-link" data-layout="circular">Circular</a>
            <a href="#" class="nav-link" data-layout="grid">Grid</a>
            <a href="#" class="nav-link" data-layout="hierarchical">Hierarchical</a>
        </div>
        <div class="nav-right">
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">ðŸŒ™</span>
            </button>
        </div>
    </nav>

    <!-- Graph Canvas -->
    <div id="graph-container">
        <svg id="graph"></svg>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Info Panel -->
    <div class="info-panel">
        <div class="info-title">âœ… Section 3: Graph Canvas</div>
        <div class="info-item">
            <span>Nodes:</span>
            <span class="info-value" id="nodeCount">0</span>
        </div>
        <div class="info-item">
            <span>Links:</span>
            <span class="info-value" id="linkCount">0</span>
        </div>
        <div class="info-item">
            <span>D3.js:</span>
            <span class="info-value">v7 âœ“</span>
        </div>
        <div class="info-item">
            <span>Status:</span>
            <span class="status-badge">RENDERING</span>
        </div>
    </div>

    <!-- Legend Bar -->
    <div class="legend">
        <div class="legend-title">Clusters</div>
        <div class="legend-items" id="legendItems"></div>
    </div>

    <!-- Stats Bubble -->
    <div class="stats-bubble" id="statsBubble" onclick="toggleStats()">
        <div class="stats-bubble-icon">ðŸ“Š</div>
        <div class="stats-expanded">
            <div class="stats-item">
                <span class="stats-label">Files</span>
                <span class="stats-value" id="totalFiles">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Projects</span>
                <span class="stats-value" id="totalProjects">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Topics</span>
                <span class="stats-value" id="totalCategories">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Storage</span>
                <span class="stats-value" id="totalStorage">0</span>
            </div>
        </div>
    </div>

    <script>
        // ===== SECTION 3: GRAPH CANVAS JAVASCRIPT =====

        // Theme system
        let currentTheme = localStorage.getItem('theme') || 'light';

        function initTheme() {
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeIcon').textContent = 'ðŸŒ™';
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeIcon').textContent = 'ðŸŒ™';
            }
            localStorage.setItem('theme', currentTheme);
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Sample graph data (from working file)
        const graphData = {
            nodes: [
                {id: "education", name: "Education", cluster: "education", size: 30, type: "topic", files: 239, lastModified: "2025-09-08"},
                {id: "oxford", name: "Oxford AI", cluster: "education", size: 25, type: "project", files: 45, lastModified: "2025-09-10"},
                {id: "research", name: "AI Research", cluster: "research", size: 20, type: "topic", files: 10, lastModified: "2025-09-07"},
                {id: "technical", name: "Technical", cluster: "technical", size: 25, type: "topic", files: 8, lastModified: "2025-09-05"},
                {id: "agentic", name: "Agentic AI", cluster: "technical", size: 20, type: "project", files: 24, lastModified: "2025-09-10"},
                {id: "professional", name: "Professional", cluster: "professional", size: 28, type: "topic", files: 13, lastModified: "2025-09-09"},
                {id: "system", name: "System", cluster: "system", size: 18, type: "topic", files: 20, lastModified: "2025-09-10"}
            ],
            links: [
                {source: "education", target: "oxford", strength: 0.9, type: "contains"},
                {source: "oxford", target: "research", strength: 0.8, type: "semantic"},
                {source: "technical", target: "agentic", strength: 0.9, type: "contains"},
                {source: "technical", target: "research", strength: 0.7, type: "semantic"},
                {source: "professional", target: "education", strength: 0.6, type: "related"}
            ]
        };

        // Cluster colors - EXACT from working file
        const clusters = {
            system: { name: "System", color: "#6366f1" },
            education: { name: "Education", color: "#4ecdc4" },
            professional: { name: "Professional", color: "#45b7d1" },
            technical: { name: "Technical", color: "#96ceb4" },
            research: { name: "Research", color: "#85c1e9" }
        };

        // Setup SVG
        const width = window.innerWidth;
        const height = window.innerHeight - 50; // Minus nav height

        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.2, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Ensure no nodes have fixed positions at start
        graphData.nodes.forEach(node => {
            node.fx = null;
            node.fy = null;
        });

        // Force simulation - EXACT settings from working file
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links)
                .id(d => d.id)
                .strength(d => d.strength * 0.5))  // EXACT from working file
            .force("charge", d3.forceManyBody().strength(-150))  // EXACT from working file
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => d.size + 5));  // EXACT from working file

        // Create links
        const link = g.append("g")
            .selectAll(".link")
            .data(graphData.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-opacity", d => d.strength * 0.4)
            .attr("stroke-width", d => d.strength * 2);

        // Create nodes
        const node = g.append("g")
            .selectAll(".node")
            .data(graphData.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", d => d.size)
            .attr("fill", d => d.type === "files" ? "white" : clusters[d.cluster]?.color || "#999")
            .attr("stroke", d => clusters[d.cluster]?.color || "#999")
            .call(d3.drag()  // EXACT drag implementation from working file
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("mouseover", showTooltip)
            .on("mouseout", hideTooltip)
            .on("click", highlightNode);

        // Add link tooltips
        link
            .on("mouseover", showLinkTooltip)
            .on("mouseout", hideTooltip);

        // Update positions on simulation tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });

        // Drag functions - EXACT from working file
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tooltip - EXACT enhanced structure from working file
        const tooltip = d3.select("#tooltip");

        function showTooltip(event, d) {
            const tooltipHtml = `
                <div class="tooltip-header">${d.name}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Type:</span>
                    <span class="tooltip-value">${d.type || 'N/A'}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Category:</span>
                    <span class="tooltip-value">${clusters[d.cluster]?.name || 'Unknown'}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Files:</span>
                    <span class="tooltip-value">${d.files || 0}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Modified:</span>
                    <span class="tooltip-value">${d.lastModified || 'Unknown'}</span>
                </div>
            `;

            tooltip
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .classed("visible", true)
                .html(tooltipHtml);
        }

        function hideTooltip() {
            tooltip.classed("visible", false);
        }

        // Link tooltip
        function showLinkTooltip(event, d) {
            const tooltipHtml = `
                <div class="tooltip-header">Connection</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Type:</span>
                    <span class="tooltip-value">${d.type || 'related'}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Strength:</span>
                    <span class="tooltip-value">${d.strength || 0}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">From:</span>
                    <span class="tooltip-value">${d.source.name || d.source.id}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">To:</span>
                    <span class="tooltip-value">${d.target.name || d.target.id}</span>
                </div>
            `;

            tooltip
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .classed("visible", true)
                .html(tooltipHtml);
        }

        // Highlight functionality
        let highlightedNodes = new Set();

        function highlightNode(event, d) {
            if (highlightedNodes.has(d.id)) {
                // Reset if already highlighted
                highlightedNodes.clear();
                node.classed("highlighted", false).classed("dimmed", false);
                label.classed("dimmed", false);
                link.classed("highlighted", false);
            } else {
                // Highlight related nodes
                highlightedNodes.clear();
                highlightedNodes.add(d.id);

                // Add connected nodes
                graphData.links.forEach(l => {
                    if (l.source.id === d.id || l.target.id === d.id) {
                        highlightedNodes.add(l.source.id);
                        highlightedNodes.add(l.target.id);
                    }
                });

                node.classed("highlighted", n => highlightedNodes.has(n.id))
                    .classed("dimmed", n => !highlightedNodes.has(n.id));
                label.classed("dimmed", n => !highlightedNodes.has(n.id));
                link.classed("highlighted", l =>
                    highlightedNodes.has(l.source.id) && highlightedNodes.has(l.target.id));
            }
        }

        // Calculate cluster statistics
        function calculateClusterStats() {
            Object.keys(clusters).forEach(key => {
                clusters[key].fileCount = 0;
            });

            graphData.nodes.forEach(node => {
                if (clusters[node.cluster]) {
                    clusters[node.cluster].fileCount += node.files || 0;
                }
            });
        }

        // Create legend
        function createLegend() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            Object.entries(clusters).forEach(([key, cluster]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.dataset.cluster = key;
                item.onclick = () => filterByCluster(key);

                const colorDot = document.createElement('div');
                colorDot.className = 'legend-color';
                colorDot.style.backgroundColor = cluster.color;

                const label = document.createElement('div');
                label.className = 'legend-label';
                label.innerHTML = `${cluster.name} <span class="legend-count">(${cluster.fileCount || 0})</span>`;

                item.appendChild(colorDot);
                item.appendChild(label);
                legendItems.appendChild(item);
            });
        }

        // Filter by cluster
        let activeFilter = null;

        function filterByCluster(clusterKey) {
            const legendItems = document.querySelectorAll('.legend-item');

            if (activeFilter === clusterKey) {
                // Reset filter
                activeFilter = null;
                node.classed("dimmed", false);
                link.style("opacity", d => d.strength * 0.4);

                // Remove active class from all legend items
                legendItems.forEach(item => item.classList.remove('active'));
            } else {
                // Apply filter
                activeFilter = clusterKey;
                const clusterNodes = new Set(graphData.nodes.filter(d => d.cluster === clusterKey).map(d => d.id));

                node.classed("dimmed", d => !clusterNodes.has(d.id));
                link.style("opacity", l =>
                    clusterNodes.has(l.source.id) && clusterNodes.has(l.target.id) ?
                    l.strength * 0.4 : 0.05);

                // Update active class on legend items
                legendItems.forEach(item => {
                    if (item.dataset.cluster === clusterKey) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // Stats bubble toggle
        function toggleStats() {
            const bubble = document.getElementById('statsBubble');
            bubble.classList.toggle('expanded');
        }

        // Calculate and display total stats
        function updateTotalStats() {
            const totalFiles = graphData.nodes.reduce((sum, node) => sum + (node.files || 0), 0);
            const totalProjects = graphData.nodes.filter(node => node.type === 'project').length;
            const totalTopics = graphData.nodes.filter(node => node.type === 'topic').length;

            // Calculate storage (placeholder - would come from real data)
            const totalStorageMB = graphData.nodes.reduce((sum, node) => sum + (node.size || 0) * 10, 0);
            const storageDisplay = totalStorageMB >= 1000 ?
                (totalStorageMB / 1000).toFixed(1) + 'GB' :
                totalStorageMB + 'MB';

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('totalCategories').textContent = totalTopics;
            document.getElementById('totalStorage').textContent = storageDisplay;
        }

        // Update info panel
        document.getElementById('nodeCount').textContent = graphData.nodes.length;
        document.getElementById('linkCount').textContent = graphData.links.length;

        // Initialize legend and stats
        calculateClusterStats();
        createLegend();
        updateTotalStats();

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight - 50;
            svg.attr("width", newWidth).attr("height", newHeight);
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', initTheme);

        // Log success
        console.log('âœ… Section 3: Graph Canvas loaded successfully');
        console.log('   - D3.js v7: âœ“');
        console.log('   - SVG canvas: âœ“');
        console.log('   - Force simulation: âœ“');
        console.log('   - Drag behavior (no snake bug): âœ“');
        console.log('   - Node tooltips (hover nodes): âœ“');
        console.log('   - Link tooltips (hover lines): âœ“');
        console.log('   - Soft color palette: âœ“');
        console.log('   - Visible connection lines (darker): âœ“');
        console.log('   - Thinner outlines (0.5px): âœ“');
        console.log('   - Legend with file counts: âœ“');
        console.log('   - Horizontal scroll legend: âœ“');
        console.log('   - Active state shadow: âœ“');
        console.log('   - Stats bubble (click ðŸ“Š): âœ“');
        console.log('   - Labels removed: âœ“');
        console.log(`   - Rendered: ${graphData.nodes.length} nodes, ${graphData.links.length} links`);
    </script>
</body>
</html>
